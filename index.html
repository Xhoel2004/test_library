<!DOCTYPE html>
<html lang="sq">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista e Librave</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- DataTables CSS -->
    <link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
</head>

<body>

    <!-- Wave Background -->
    <div class="wave-container">
        <div class="wave"></div>
    </div>

    <div class="container mt-5">
        <h2 class="text-center mb-4">ðŸ“š Lista e Librave</h2>

        <div class="text-end mb-3">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addModal" id="openAddModal">
                <i class="bi bi-plus-circle me-2"></i>Shto LibÃ«r
            </button>
        </div>

        <div class="table-container">
            <table id="booksTable" class="table table-bordered table-hover align-middle text-center">
                <thead>
                    <tr>
                        <th>Foto</th>
                        <th>Titulli</th>
                        <th>Autori</th>
                        <th>Kategoria</th>
                        <th>ISBN</th>
                        <th>Viti</th>
                        <th>Gjendja</th>
                        <th>Veprime</th>
                    </tr>
                </thead>
                <tbody id="bookList"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal Shto Liber -->
    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-book me-2"></i>Shto LibÃ«r tÃ« Ri</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addForm" novalidate>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-card-heading me-2"></i>Titulli</label>
                            <input type="text" id="title" class="form-control" required minlength="2" maxlength="100" placeholder="Vendos titullin e librit">
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-person me-2"></i>Autori</label>
                            <input type="text" id="author" class="form-control" required minlength="2" maxlength="100" placeholder="Shkruaj emrin e autorit">
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-tag me-2"></i>Kategoria</label>
                            <select id="category" class="form-select" required>
                                <option value="">Zgjidh kategorinÃ«</option>
                                <option>Roman</option>
                                <option>Histori</option>
                                <option>Fantazi</option>
                                <option>ShkencÃ«</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-upc me-2"></i>ISBN</label>
                            <input type="text" id="isbn" class="form-control" pattern="[0-9\-]{10,17}" required
                                placeholder="p.sh. 978-1234567890">
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-calendar me-2"></i>Viti</label>
                            <input type="number" id="year" class="form-control" min="1500" max="2100" required placeholder="Viti i botimit">
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-check-circle me-2"></i>Gjendja</label>
                            <select id="condition" class="form-select" required>
                                <option value="">Zgjidh gjendjen</option>
                                <option>I ri</option>
                                <option>I pÃ«rdorur</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-image me-2"></i>Foto</label>
                            <input type="file" id="image" accept="image/*" class="form-control" required>
                            <img id="addPreview" class="img-preview"
                                src="https://via.placeholder.com/120x160?text=Nuk+ka+foto">
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-image me-2"></i>Foto (opsionale)</label>
                            <input type="file" id="image" accept="image/*" class="form-control">
                            <img id="addPreview" class="img-preview"
                                src="https://via.placeholder.com/120x160?text=Nuk+ka+foto">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-save me-2"></i>Shto Librin
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Edito Liber -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Ndrysho Librin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editForm" novalidate>
                    <div class="modal-body">
                        <input type="hidden" id="editIndex">
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-card-heading me-2"></i>Titulli</label>
                            <input type="text" id="editTitle" class="form-control" required minlength="2"
                                maxlength="100">
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-person me-2"></i>Autori</label>
                            <input type="text" id="editAuthor" class="form-control" required minlength="2" maxlength="100" placeholder="Shkruaj emrin e autorit">
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-tag me-2"></i>Kategoria</label>
                            <select id="editCategory" class="form-select" required>
                                <option value="">Zgjidh kategorinÃ«</option>
                                <option>Roman</option>
                                <option>Histori</option>
                                <option>Fantazi</option>
                                <option>ShkencÃ«</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-upc me-2"></i>ISBN</label>
                            <input type="text" id="editIsbn" class="form-control" pattern="[0-9\-]{10,17}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-calendar me-2"></i>Viti</label>
                            <input type="number" id="editYear" class="form-control" min="1500" max="2100" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-check-circle me-2"></i>Gjendja</label>
                            <select id="editCondition" class="form-select" required>
                                <option value="">Zgjidh gjendjen</option>
                                <option>I ri</option>
                                <option>I pÃ«rdorur</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-image me-2"></i>Foto</label>
                            <input type="file" id="editImage" accept="image/*" class="form-control">
                            <img id="editPreview" class="img-preview" src="">
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-image me-2"></i>Foto</label>
                            <input type="file" id="editImage" accept="image/*" class="form-control">
                            <img id="editPreview" class="img-preview" src="">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-save me-2"></i>Ruaj Ndryshimet
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap + JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest"></script>

    <script>
        const bookList = document.getElementById('bookList');
        let books = JSON.parse(localStorage.getItem('books')) || [];

        const addPreview = document.getElementById('addPreview');
        const editPreview = document.getElementById('editPreview');

        // Reset form kur hap modalin e shtimit
        document.getElementById('openAddModal').addEventListener('click', () => {
            document.getElementById('addForm').reset();
            addPreview.src = 'https://via.placeholder.com/120x160?text=Nuk+ka+foto';
        });

        // Shfaq parapamje imazhi
        document.getElementById('image').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) addPreview.src = URL.createObjectURL(file);
        });
        document.getElementById('editImage').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) editPreview.src = URL.createObjectURL(file);
        });

        // Renderimi i librave
        function renderBooks() {
            bookList.innerHTML = '';
            books.forEach((b, i) => {
                bookList.innerHTML += `
                <tr>
                    <td><img src="${b.image}" class="cover" alt="${b.title}"></td>
                    <td><strong>${b.title}</strong></td>
                    <td>${b.author}</td>
                    <td><span class="badge bg-primary">${b.category}</span></td>
                    <td><small>${b.isbn}</small></td>
                    <td>${b.year}</td>
                    <td><span class="badge ${b.condition === 'I ri' ? 'bg-success' : 'bg-warning'}">${b.condition}</span></td>
                    <td>
                        <button class="btn btn-sm btn-success me-2" onclick="openEdit(${i})" title="Edito">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBook(${i})" title="Fshi">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            });
            localStorage.setItem('books', JSON.stringify(books));
            if (window.dataTable) window.dataTable.destroy();
            window.dataTable = new simpleDatatables.DataTable("#booksTable", {
                searchable: true,
                sortable: true,
                perPage: 10,
                perPageSelect: [5, 10, 15, 20],
                labels: {
                    placeholder: "KÃ«rko...",
                    perPage: "libra pÃ«r faqe",
                    noRows: "Nuk ka tÃ« dhÃ«na",
                    info: "Shfaqen {start} deri {end} nga {rows} libra"
                }
            });
        }

        // Shto liber
        document.getElementById('addForm').addEventListener('submit', e => {
            e.preventDefault();
            if (!e.target.checkValidity()) {
                e.stopPropagation();
                e.target.classList.add('was-validated');
                return;
            }

            const file = document.getElementById('image').files[0];
            const reader = new FileReader();
            reader.onload = ev => {
                books.push({
                    title: document.getElementById('title').value.trim(),
                    author: document.getElementById('author').value.trim(),
                    category: document.getElementById('category').value,
                    isbn: document.getElementById('isbn').value.trim(),
                    year: document.getElementById('year').value,
                    condition: document.getElementById('condition').value,
                    image: ev.target.result
                });
                localStorage.setItem('books', JSON.stringify(books));
                renderBooks();
                bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
                location.reload();
            };
            reader.readAsDataURL(file);
        });

        // Edito liber
        function openEdit(i) {
            const b = books[i];
            document.getElementById('editIndex').value = i;
            document.getElementById('editTitle').value = b.title;
            document.getElementById('editAuthor').value = b.author;
            document.getElementById('editCategory').value = b.category;
            document.getElementById('editIsbn').value = b.isbn;
            document.getElementById('editYear').value = b.year;
            document.getElementById('editCondition').value = b.condition;
            editPreview.src = b.image;
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        document.getElementById('editForm').addEventListener('submit', e => {
            e.preventDefault();
            const i = document.getElementById('editIndex').value;
            const file = document.getElementById('editImage').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = ev => {
                    books[i].image = ev.target.result;
                    saveEdit(i);
                };
                reader.readAsDataURL(file);
            } else saveEdit(i);
        });

        function saveEdit(i) {
            books[i].title = document.getElementById('editTitle').value.trim();
            books[i].author = document.getElementById('editAuthor').value.trim();
            books[i].category = document.getElementById('editCategory').value;
            books[i].isbn = document.getElementById('editIsbn').value.trim();
            books[i].year = document.getElementById('editYear').value;
            books[i].condition = document.getElementById('editCondition').value;
            localStorage.setItem('books', JSON.stringify(books));
            renderBooks();
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            location.reload();
        }

        // Fshi liber
        function deleteBook(i) {
            if (confirm("A jeni i sigurt qÃ« doni ta fshini kÃ«tÃ« libÃ«r?")) {
                books.splice(i, 1);
                renderBooks();
                location.reload();
            }
        }

        // Funksion qÃ« vendos mesazhe personalizuese pÃ«r Ã§do fushÃ«
        function setupValidation() {
            const rules = [
                { id: "title", msg: "Titulli duhet tÃ« ketÃ« tÃ« paktÃ«n 2 karaktere." },
                { id: "author", msg: "Autori duhet tÃ« ketÃ« tÃ« paktÃ«n 2 karaktere." },
                { id: "category", msg: "Zgjidh njÃ« kategori." },
                { id: "isbn", msg: "Formati i gabuar! Duhet p.sh. 978-1234567890." },
                { id: "year", msg: "Vendos njÃ« vit midis 1500 dhe 2100." },
                { id: "condition", msg: "Zgjidh gjendjen e librit." },
                { id: "image", msg: "Ngarko njÃ« foto pÃ«r librin." },
            ];

            rules.forEach(({ id, msg }) => {
                const input = document.getElementById(id);
                if (!input) return;

                input.addEventListener("input", function () {
                    if (this.validity.valueMissing) {
                        this.setCustomValidity("Kjo fushÃ« Ã«shtÃ« e detyrueshme.");
                    } else if (this.validity.tooShort) {
                        this.setCustomValidity(msg);
                    } else if (this.validity.patternMismatch) {
                        this.setCustomValidity(msg);
                    } else if (this.validity.rangeUnderflow || this.validity.rangeOverflow) {
                        this.setCustomValidity(msg);
                    } else {
                        this.setCustomValidity("");
                    }
                });
            });

            const editRules = [
                { id: "editTitle", msg: "Titulli duhet tÃ« ketÃ« tÃ« paktÃ«n 2 karaktere." },
                { id: "editAuthor", msg: "Autori duhet tÃ« ketÃ« tÃ« paktÃ«n 2 karaktere." },
                { id: "editCategory", msg: "Zgjidh njÃ« kategori." },
                { id: "editIsbn", msg: "Formati i gabuar! Duhet p.sh. 978-1234567890." },
                { id: "editYear", msg: "Vendos njÃ« vit midis 1500 dhe 2100." },
                { id: "editCondition", msg: "Zgjidh gjendjen e librit." },
            ];

            editRules.forEach(({ id, msg }) => {
                const input = document.getElementById(id);
                if (!input) return;

                input.addEventListener("input", function () {
                    if (this.validity.valueMissing) {
                        this.setCustomValidity("Kjo fushÃ« Ã«shtÃ« e detyrueshme.");
                    } else if (this.validity.tooShort) {
                        this.setCustomValidity(msg);
                    } else if (this.validity.patternMismatch) {
                        this.setCustomValidity(msg);
                    } else if (this.validity.rangeUnderflow || this.validity.rangeOverflow) {
                        this.setCustomValidity(msg);
                    } else {
                        this.setCustomValidity("");
                    }
                });
            });
        }

        document.getElementById('addForm').addEventListener('submit', function (e) {
            if (!this.checkValidity()) {
                e.preventDefault();
                e.stopPropagation();
                this.reportValidity();
            }
        }, true);

        document.getElementById('editForm').addEventListener('submit', function (e) {
            if (!this.checkValidity()) {
                e.preventDefault();
                e.stopPropagation();
                this.reportValidity();
            }
        }, true);

        setupValidation();
        renderBooks();
    </script>

</body>

</html>